name: Full Stack CI/CD (Spring + Next.js)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # --- [1. BACK-END BUILD] ---
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: make application.properties
      run: |
        mkdir -p ./Back-end/shop-1/shop-1/shop-1/src/main/resources
        echo "${{ secrets.APPLICATION_PROPERTIES }}" > ./Back-end/shop-1/shop-1/shop-1/src/main/resources/application.properties

    - name: Build with Gradle
      working-directory: ./Back-end/shop-1/shop-1/shop-1
      run: |
        chmod +x ./gradlew
        ./gradlew clean build -x test

    # --- [2. FRONT-END BUILD] ---
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: make .env.local
      run: echo "${{ secrets.ENV_LOCAL }}" > ./Front-end/frontend/.env.local

    - name: Install Frontend Dependencies & Build
      working-directory: ./Front-end/frontend
      run: |
        npm install
        npm run build

    # --- [3. TRANSFER FILES TO EC2] ---
    - name: Copy Files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "Back-end/shop-1/shop-1/shop-1/build/libs/*.jar,Front-end/frontend/.next,Front-end/frontend/public,Front-end/frontend/package.json,Front-end/frontend/next.config.js"
        target: "/home/ubuntu/deploy"
        strip_components: 0

    # --- [4. DEPLOY TO DOCKER] ---
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # 백엔드 배포 준비
          mkdir -p ~/app
          cp ~/deploy/Back-end/shop-1/shop-1/shop-1/build/libs/*.jar ~/app/app.jar
          
          # 백엔드 Dockerfile 생성
          echo "FROM openjdk:17-jdk-slim
          COPY app.jar app.jar
          ENTRYPOINT [\"java\", \"-jar\", \"/app.jar\"]" > ~/app/Dockerfile

          # 백엔드 실행
          sudo docker stop shop-app || true
          sudo docker rm shop-app || true
          cd ~/app
          sudo docker build -t shop-app .
          sudo docker run -d \
            --name shop-app \
            -p 8080:8080 \
            --network shop-network \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://shop-mysql:3306/shop1 \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            -e KAKAO_REDIRECT_URI=http://${{ secrets.EC2_HOST }}:8080/auth/kakao/callback \
            shop-app

          # 프론트엔드 배포 준비
          mkdir -p ~/front
          cp -r ~/deploy/Front-end/frontend/.next ~/front/
          cp -r ~/deploy/Front-end/frontend/public ~/front/
          cp ~/deploy/Front-end/frontend/package.json ~/front/
          cp ~/deploy/Front-end/frontend/next.config.js ~/front/

          echo "FROM node:20-slim
          WORKDIR /app
          COPY . .
          RUN npm install --production
          CMD [\"npm\", \"start\"]" > ~/front/Dockerfile

          sudo docker stop shop-front || true
          sudo docker rm shop-front || true
          cd ~/front
          sudo docker build -t shop-front .
          sudo docker run -d --name shop-front -p 3000:3000 shop-front

          rm -rf ~/deploy
