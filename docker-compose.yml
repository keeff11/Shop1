version: '3.8'

services:
  # 1. ë°ì´í„°ë² ì´ìŠ¤ (MySQL)
  db:
    image: mysql:8.0
    container_name: shop1-db
    restart: always
    ports:
      - "3306:3306"
    environment:
      MYSQL_DATABASE: shop1
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      TZ: Asia/Seoul
    volumes:
      - ./mysql_data:/var/lib/mysql
    networks:
      - shop1-network

  # 2. Redis (ìºì‹œ ì„œë²„)
  redis:
    image: redis:alpine
    container_name: shop1-redis
    restart: always
    ports:
      - "6379:6379"
    networks:
      - shop1-network

  # ğŸŒŸ 3. Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.10
    container_name: shop1-elasticsearch
    volumes:
      - es_data:/usr/share/elasticsearch/data
    environment:
      - discovery.type=single-node 
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m" 
      - xpack.security.enabled=false     
      - xpack.security.http.ssl.enabled=false
    ports:
      # ğŸŒŸ ì¤‘ìš”: í•´í‚¹ ë°©ì§€ë¥¼ ìœ„í•´ 127.0.0.1ë¡œ ë¡œì»¬ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ì œí•œ
      - "127.0.0.1:9200:9200"
      - "127.0.0.1:9300:9300"
    command: >
      bash -c "
      bin/elasticsearch-plugin install --batch analysis-nori;
      /usr/local/bin/docker-entrypoint.sh
      "
    # ğŸŒŸ ì¶”ê°€: ë°±ì—”ë“œì™€ í†µì‹ í•˜ê¸° ìœ„í•´ ê°™ì€ ë„¤íŠ¸ì›Œí¬ì— ì†Œì†ì‹œí‚´
    networks:
      - shop1-network

  # ğŸŒŸ 4. ë°±ì—”ë“œ (Spring Boot) (ìˆ˜ì •ë¨)
  backend:
    build: ./Back-end/shop-1/shop-1/shop-1
    container_name: shop1-backend
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - db
      - redis
      - elasticsearch # ESê°€ ì¼œì§„ í›„ ë°±ì—”ë“œê°€ ì¼œì§€ë„ë¡ ìˆœì„œ ë³´ì¥
    environment:
      # ğŸŒŸ ì¶”ê°€: Spring Bootì— ë©”ëª¨ë¦¬ ë‹¤ì´ì–´íŠ¸ ëª…ë ¹ í•˜ë‹¬ (OOM Killer ë°©ì§€)
      JAVA_TOOL_OPTIONS: "-Xms256m -Xmx512m"
      
      # DB ì—°ê²° ì„¤ì •
      DB_HOST: shop1-db
      DB_USERNAME: root
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD} 
      
      # Redis ì—°ê²° ì„¤ì •
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379

      # ğŸŒŸ ì¶”ê°€: ES ì—°ê²° ì£¼ì†Œë¥¼ ë„ì»¤ ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ ëª…ì‹œ
      SPRING_ELASTICSEARCH_URIS: http://elasticsearch:9200
      
      # CORS ì„¤ì •
      CORS_ALLOWED_ORIGINS: ${FRONTEND_URL}
      
      TZ: Asia/Seoul
    networks:
      - shop1-network

  # 5. í”„ë¡ íŠ¸ì—”ë“œ (Next.js)
  frontend:
    build: ./Front-end/frontend
    container_name: shop1-frontend
    restart: always
    ports:
      - "3000:3000"
    depends_on:
      - backend
    networks:
      - shop1-network

networks:
  shop1-network:
    name: shop1-network
    driver: bridge

volumes:
  es_data: