name: Full Stack CI/CD (Spring + Next.js)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # --- [BACK-END BUILD] ---
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: make application.properties
      run: |
        mkdir -p ./Back-end/shop-1/shop-1/shop-1/src/main/resources
        echo "${{ secrets.APPLICATION_PROPERTIES }}" > ./Back-end/shop-1/shop-1/shop-1/src/main/resources/application.properties

    - name: Build with Gradle
      working-directory: ./Back-end/shop-1/shop-1/shop-1
      run: |
        chmod +x ./gradlew
        ./gradlew clean build -x test

    # --- [FRONT-END BUILD] ---
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: make .env.local
      run: echo "${{ secrets.ENV_LOCAL }}" > ./Front-end/.env.local # 폴더명 확인 필요

    - name: Install Frontend Dependencies & Build
      working-directory: ./Front-end # 폴더명 확인 필요
      run: |
        npm install
        npm run build

    # --- [TRANSFER FILES] ---
    - name: Copy JAR and Front Files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        # 백엔드 jar와 프론트엔드 폴더 전체를 전송
        source: "Back-end/shop-1/shop-1/shop-1/build/libs/*.jar,Front-end/.next,Front-end/public,Front-end/package.json,Front-end/next.config.js"
        target: "/home/ubuntu/deploy"
        strip_components: 0 # 경로 유지를 위해 0으로 설정 후 서버에서 정리

    # --- [DEPLOY TO EC2] ---
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # 1. 파일 정리 (홈 디렉토리로 이동)
          cp ~/deploy/Back-end/shop-1/shop-1/shop-1/build/libs/shop-1-0.0.1-SNAPSHOT.jar ~/app.jar
          cp -r ~/deploy/Front-end/* ~/front/
          
          # 2. 백엔드 실행
          sudo docker stop shop-app || true
          sudo docker rm shop-app || true
          sudo docker build -t shop-app .
          sudo docker run -d --name shop-app -p 8080:8080 --link shop-mysql:shop-mysql shop-app
          
          # 3. 프론트엔드 실행 (서버에 프론트용 Dockerfile이 있어야 함)
          sudo docker stop shop-front || true
          sudo docker rm shop-front || true
          cd ~/front
          sudo docker build -t shop-front .
          sudo docker run -d --name shop-front -p 3000:3000 shop-front
